---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import { getPostCoverTokens } from "../../lib/posts/coverTokens";

interface Props {
  post: CollectionEntry<"posts">;
  variant?: "hero" | "card" | "archive-square";
}

const { post, variant = "card" } = Astro.props;
const hasManualCover = Boolean(post.data.cover?.src);
const tokens = getPostCoverTokens(post.slug);

const fallbackStyle = [
  `--cover-c1: ${tokens.palette[0]}`,
  `--cover-c2: ${tokens.palette[1]}`,
  `--cover-c3: ${tokens.palette[2]}`,
  `--cover-accent: ${tokens.accent}`,
  `--cover-tilt: ${tokens.tilt}deg`
].join("; ");

const coverSizes =
  variant === "hero"
    ? "(max-width: 980px) calc(100vw - 2rem), 980px"
    : variant === "archive-square"
      ? "(max-width: 760px) calc(100vw - 2rem), (max-width: 1160px) 32vw, 240px"
      : "(max-width: 720px) calc(100vw - 2rem), (max-width: 1200px) 48vw, 360px";
---

<figure
  class:list={["post-cover", `post-cover--${variant}`, !hasManualCover && "post-cover--fallback"]}
  data-post-cover={variant}
>
  {
    hasManualCover ? (
      <Image
        src={post.data.cover!.src}
        alt={post.data.cover!.alt}
        width={1600}
        height={900}
        class="post-cover-image"
        loading={variant === "hero" ? "eager" : "lazy"}
        decoding="async"
        sizes={coverSizes}
      />
    ) : (
      <div
        class="post-cover-fallback"
        style={fallbackStyle}
        data-pattern={tokens.pattern}
        role="img"
        aria-label={`${post.data.title} fallback cover`}
      >
        <div class="post-cover-grid" aria-hidden="true"></div>
        <div class="post-cover-shape" aria-hidden="true"></div>
        <p class="post-cover-kicker">{tokens.badge}</p>
        <p class="post-cover-title">{post.data.title}</p>
      </div>
    )
  }

  {
    variant === "hero" && post.data.cover?.credit ? (
      <figcaption class="post-cover-credit subtle">{post.data.cover.credit}</figcaption>
    ) : null
  }
</figure>
