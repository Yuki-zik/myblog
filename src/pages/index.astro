---
import { getCollection } from "astro:content";
import PostCard from "../components/post/PostCard.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

const [topics, posts] = await Promise.all([
  getCollection("topics"),
  getCollection("posts", ({ data }) => !data.draft)
]);

const sortedTopics = topics.sort((a, b) => {
  const orderA = a.data.order ?? Number.POSITIVE_INFINITY;
  const orderB = b.data.order ?? Number.POSITIVE_INFINITY;
  if (orderA !== orderB) {
    return orderA - orderB;
  }
  return a.data.title.localeCompare(b.data.title, "zh-CN");
});

const latestPosts = [...posts]
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 6);

const postCountByTopic = posts.reduce<Record<string, number>>((acc, post) => {
  post.data.topics.forEach((topicSlug) => {
    acc[topicSlug] = (acc[topicSlug] ?? 0) + 1;
  });
  return acc;
}, {});
---

<BaseLayout title="MyBlog | 主题化知识网络">
  <section class="content-section">
    <h1>主题化知识网络</h1>
    <p class="subtle">从主题进入，再落到文章与段落短评。</p>
  </section>

  <section class="grid topic-grid">
    {
      sortedTopics.map((topic) => (
        <article class="card">
          <h3>
            <a href={`/topics/${topic.slug}`}>{topic.data.title}</a>
          </h3>
          <p>{topic.data.summary}</p>
          <p class="subtle" style="margin-top: 0.6rem;">
            相关文章 {postCountByTopic[topic.slug] ?? 0} 篇
          </p>
        </article>
      ))
    }
  </section>

  <section class="content-section" data-latest-posts>
    <h2>最新文章</h2>
    <p class="subtle">每篇文章都提供封面图，帮助你更快定位主题和上下文。</p>

    {
      latestPosts.length === 0 ? (
        <p class="subtle">暂时还没有可展示的文章。</p>
      ) : (
        <div class="grid post-card-grid">
          {latestPosts.map((post) => <PostCard post={post} />)}
        </div>
      )
    }
  </section>

  <section class="content-section home-archive-entry" data-home-archive-entry>
    <h2>时间归档</h2>
    <p class="subtle">按年与月份浏览全部文章，快速定位你错过的内容。</p>
    <a class="archive-entry-button" href="/archives">进入归档时间轴</a>
  </section>
</BaseLayout>
