---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const [topics, posts] = await Promise.all([
  getCollection("topics"),
  getCollection("posts", ({ data }) => !data.draft)
]);

const sortedTopics = topics.sort((a, b) => {
  const orderA = a.data.order ?? Number.POSITIVE_INFINITY;
  const orderB = b.data.order ?? Number.POSITIVE_INFINITY;
  if (orderA !== orderB) {
    return orderA - orderB;
  }
  return a.data.title.localeCompare(b.data.title, "zh-CN");
});

const postCountByTopic = posts.reduce<Record<string, number>>((acc, post) => {
  post.data.topics.forEach((topicSlug) => {
    acc[topicSlug] = (acc[topicSlug] ?? 0) + 1;
  });
  return acc;
}, {});
---

<BaseLayout title="MyBlog | 主题化知识网络">
  <section class="content-section">
    <h1>主题化知识网络</h1>
    <p class="subtle">从主题进入，再落到文章与段落短评。</p>
  </section>

  <section class="grid topic-grid">
    {
      sortedTopics.map((topic) => (
        <article class="card">
          <h3>
            <a href={`/topics/${topic.slug}`}>{topic.data.title}</a>
          </h3>
          <p>{topic.data.summary}</p>
          <p class="subtle" style="margin-top: 0.6rem;">
            相关文章 {postCountByTopic[topic.slug] ?? 0} 篇
          </p>
        </article>
      ))
    }
  </section>
</BaseLayout>
